<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Step-Up Counter</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="StepUp"/>
<meta name="theme-color" content="#08080F"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:#08080F;overscroll-behavior:none;font-family:'Courier New',Courier,monospace;color:#E0E0F0}
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
button{font-family:inherit;cursor:pointer}
#app{padding:12px 16px;padding-top:max(12px,env(safe-area-inset-top));padding-bottom:max(24px,env(safe-area-inset-bottom));min-height:100vh}
.glow{position:fixed;top:-20%;left:-10%;width:65vw;height:65vw;border-radius:50%;background:radial-gradient(circle,rgba(0,255,150,0.07) 0%,transparent 70%);pointer-events:none}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.app-title{font-size:16px;font-weight:bold;letter-spacing:3px;color:#00FF96}
.app-sub{font-size:10px;letter-spacing:1.5px;color:#555;margin-top:2px}
.pill{font-size:11px;background:rgba(0,255,150,0.08);border:1px solid rgba(0,255,150,0.2);border-radius:20px;padding:5px 11px;color:#00FF96}
.pill.err{color:#FF6B6B}
.model-toggle{display:flex;gap:8px;margin-bottom:12px}
.model-btn{flex:1;padding:10px 0;border-radius:10px;font-size:11px;font-weight:bold;letter-spacing:1.5px;border:1px solid #2A2A3A;background:transparent;color:#555;transition:all 0.2s}
.model-btn.active{border-color:rgba(0,255,150,0.4);background:rgba(0,255,150,0.08);color:#00FF96}
.model-desc{font-size:10px;color:#444;text-align:center;margin-bottom:12px;line-height:16px}
.videobox{background:#10101A;border-radius:12px;border:1px solid #1E1E30;overflow:hidden;min-height:200px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;position:relative}
#vid{width:100%;display:block;min-height:200px;background:#000}
#cv{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.empty{text-align:center;padding:40px 20px;width:100%}
.empty-icon{font-size:52px}
.empty-txt{color:#555;font-size:14px;margin-top:10px}
.empty-hint{color:#333;font-size:11px;margin-top:6px}
.choose-btn{width:100%;padding:14px 0;background:linear-gradient(135deg,#00FF96,#00C97A);color:#08080F;border:none;border-radius:10px;font-size:14px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.choose-btn:disabled{background:#111;color:#444;opacity:0.5;cursor:not-allowed}
.status-msg{text-align:center;font-size:12px;color:#FFD700;margin-bottom:8px;min-height:20px}
.done-banner{background:rgba(0,255,150,0.08);border:1px solid rgba(0,255,150,0.2);border-radius:10px;padding:12px 16px;margin-bottom:12px;color:#00FF96;font-size:15px;text-align:center;display:none;font-weight:bold;letter-spacing:2px}
.stats{display:flex;gap:10px;margin-bottom:12px}
.rep-card{background:linear-gradient(135deg,rgba(0,255,150,0.09),rgba(0,255,150,0.02));border:1px solid rgba(0,255,150,0.2);border-radius:12px;padding:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:110px}
.rep-label{font-size:10px;letter-spacing:3px;color:#00FF96;margin-bottom:6px;opacity:0.8}
.rep-num{font-size:64px;font-weight:bold;color:#00FF96;line-height:1;text-shadow:0 0 30px rgba(0,255,150,0.4)}
.rep-sub{font-size:11px;color:#444;letter-spacing:2px;margin-top:4px}
.state-card{flex:1;background:#10101A;border:1px solid #1E1E30;border-radius:12px;padding:14px}
.card-label{font-size:10px;letter-spacing:2.5px;color:#555;margin-bottom:6px}
.state-badge{font-size:22px;font-weight:bold;margin-bottom:4px}
.card-hint{font-size:10px;color:#333;line-height:15px}
.graph-box{background:#10101A;border:1px solid #1E1E30;border-radius:12px;padding:14px;margin-bottom:12px;display:none}
.graph-title{font-size:10px;letter-spacing:3px;color:#555;margin-bottom:10px;display:flex;justify-content:space-between}
.graph-title span{color:#00FF96;font-size:11px}
#graphCanvas{width:100%;border-radius:6px;display:block}
.graph-legend{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap}
.leg-item{display:flex;align-items:center;gap:5px;font-size:10px;color:#555}
.leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.reset-btn{width:100%;padding:12px 0;background:transparent;border:1px solid #2A2A3A;border-radius:10px;color:#555;font-size:12px;letter-spacing:2px;margin-bottom:8px;display:none}
.spacer{height:32px}
</style>
</head>
<body>
<div id="app">
  <div class="glow"></div>

  <div class="header">
    <div style="display:flex;align-items:center;gap:10px">
      <span style="font-size:28px">â¬†</span>
      <div>
        <div class="app-title">STEP-UP COUNTER</div>
        <div class="app-sub">AI Rep Tracker Â· Pose Detection</div>
      </div>
    </div>
    <div class="pill" id="pill">â³ Loading...</div>
  </div>

  <!-- Model selector -->

  <div class="model-toggle">
    <button class="model-btn active" id="btnMediaPipe" onclick="selectModel('mediapipe')">
      MEDIAPIPE
    </button>
    <button class="model-btn" id="btnMoveNet" onclick="selectModel('movenet')">
      MOVENET
    </button>
  </div>
  <div class="model-desc" id="modelDesc">MediaPipe Pose â€” 33 landmarks Â· accurate Â· slower</div>

  <div class="videobox">
    <div class="empty" id="empty">
      <div class="empty-icon">ğŸ¬</div>
      <div class="empty-txt">Upload a step-up workout video</div>
      <div class="empty-hint">MP4 Â· MOV Â· WebM</div>
    </div>
    <video id="vid" playsinline webkit-playsinline controls preload="auto" style="display:none"></video>
    <canvas id="cv" style="display:none"></canvas>
  </div>

<button class="choose-btn" id="chooseBtn" disabled onclick="document.getElementById('fileIn').click()">ğŸ“‚  Choose Video</button>
<input type="file" accept="video/*" id="fileIn" style="display:none"/>

  <div class="status-msg" id="statusMsg">Initialising...</div>
  <div class="done-banner" id="doneBanner"></div>

  <div class="stats">
    <div class="rep-card">
      <div class="rep-label">STEP-UPS</div>
      <div class="rep-num" id="repNum">0</div>
      <div class="rep-sub">reps</div>
    </div>
    <div class="state-card">
      <div class="card-label">STATUS</div>
      <div class="state-badge" id="stateVal" style="color:#555">--</div>
      <div class="card-hint" id="stateHint">Waiting for video...</div>
    </div>
  </div>

  <div class="graph-box" id="graphBox">
    <div class="graph-title">
      LEFT ANKLE Y â€” FULL VIDEO
      <span id="graphInfo">--</span>
    </div>
    <canvas id="graphCanvas" height="200"></canvas>
    <div class="graph-legend">
      <div class="leg-item"><div class="leg-dot" style="background:#00FF96"></div>Left ankle Y</div>
      <div class="leg-item"><div class="leg-dot" style="background:#FF6B6B"></div>Detected rep</div>
    </div>
  </div>

<button class="reset-btn" id="resetBtn" onclick="resetAll()">â†º  Reset</button>

  <div class="spacer"></div>
</div>

<script type="module">
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MP_CDN   = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14"
const MP_MODEL = "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"
const MN_CDN   = "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"
const MN_MODEL = "https://tfhub.dev/google/tfjs-model/movenet/singlepose/lightning/4"
const SMOOTH    = 0.15
const MIN_GAP   = 25
const SMOOTH_WIN= 10

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vid        = document.getElementById("vid")
const cv         = document.getElementById("cv")
const pill       = document.getElementById("pill")
const statusMsg  = document.getElementById("statusMsg")
const repNum     = document.getElementById("repNum")
const stateVal   = document.getElementById("stateVal")
const stateHint  = document.getElementById("stateHint")
const doneBanner = document.getElementById("doneBanner")
const chooseBtn  = document.getElementById("chooseBtn")
const resetBtn   = document.getElementById("resetBtn")
const empty      = document.getElementById("empty")
const graphBox   = document.getElementById("graphBox")
const graphCanvas= document.getElementById("graphCanvas")
const graphInfo  = document.getElementById("graphInfo")
const modelDesc  = document.getElementById("modelDesc")

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeModel = "mediapipe"  // "mediapipe" | "movenet"
let mpLandmarker = null
let mnModel      = null
let raf=null, lastT=-1, smoothed=null, signal=[]

// â”€â”€ Model selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.selectModel = function(model){
  if(activeModel===model) return
  activeModel=model
  document.getElementById("btnMediaPipe").classList.toggle("active", model==="mediapipe")
  document.getElementById("btnMoveNet").classList.toggle("active", model==="movenet")
  modelDesc.textContent = model==="mediapipe"
    ? "MediaPipe Pose â€” 33 landmarks Â· accurate Â· slower"
    : "MoveNet Lightning â€” 17 landmarks Â· fast Â· lightweight"
  loadModel()
}

// â”€â”€ Load MediaPipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMediaPipe(){
  statusMsg.textContent="Loading MediaPipe..."
  pill.textContent="â³ Loading..."
  chooseBtn.disabled=true
  const{PoseLandmarker,FilesetResolver}=await import(MP_CDN+"/vision_bundle.mjs")
  statusMsg.textContent="Downloading model (~10MB)..."
  const res=await FilesetResolver.forVisionTasks(MP_CDN+"/wasm")
  mpLandmarker=await PoseLandmarker.createFromOptions(res,{
    baseOptions:{modelAssetPath:MP_MODEL,delegate:"CPU"},
    runningMode:"VIDEO",numPoses:1
  })
  pill.textContent="âœ… Ready"
  statusMsg.textContent=""
  chooseBtn.disabled=false
}

// â”€â”€ Load MoveNet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMoveNet(){
  statusMsg.textContent="Loading TensorFlow.js..."
  pill.textContent="â³ Loading..."
  chooseBtn.disabled=true
  // Load TF.js dynamically
  await new Promise((res,rej)=>{
    if(window.tf){res();return}
    const s=document.createElement("script")
    s.src=MN_CDN; s.onload=res; s.onerror=rej
    document.head.appendChild(s)
  })
  statusMsg.textContent="Loading MoveNet model..."
  await window.tf.ready()
  mnModel=await window.tf.loadGraphModel(MN_MODEL,{fromTFHub:true})
  pill.textContent="âœ… Ready"
  statusMsg.textContent=""
  chooseBtn.disabled=false
}

async function loadModel(){
  try{
    if(activeModel==="mediapipe") await loadMediaPipe()
    else await loadMoveNet()
  }catch(e){
    pill.textContent="âŒ Error"
    pill.classList.add("err")
    statusMsg.textContent="Failed: "+e.message
  }
}

// â”€â”€ Get left ankle Y from each model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAnkleY_MediaPipe(lms){
  // landmark 27 = left ankle
  return lms[27] ? lms[27].y : null
}

function getAnkleY_MoveNet(keypoints){
  // MoveNet keypoint 15 = left ankle
  const ankle = keypoints[15]
  if(!ankle||ankle.score<0.3) return null
  return ankle.y  // MoveNet returns normalised 0-1
}

// â”€â”€ Skeleton draw â€” MediaPipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MP_BONES=[[23,25],[25,27],[24,26],[26,28],[23,24]]
const MP_KP=[23,24,25,26,27,28]
function drawMediaPipe(lms){
  const W=cv.width,H=cv.height
  const ctx=cv.getContext("2d")
  ctx.strokeStyle="rgba(255,215,0,0.8)"; ctx.lineWidth=3
  for(const[a,b]of MP_BONES){
    if(!lms[a]||!lms[b]) continue
    ctx.beginPath();ctx.moveTo(lms[a].x*W,lms[a].y*H);ctx.lineTo(lms[b].x*W,lms[b].y*H);ctx.stroke()
  }
  for(const i of MP_KP){
    if(!lms[i]) continue
    ctx.beginPath();ctx.arc(lms[i].x*W,lms[i].y*H,7,0,Math.PI*2)
    ctx.fillStyle=i===27?"#00FF96":i<=24?"#FF6B6B":"#FFD700"; ctx.fill()
  }
}

// â”€â”€ Skeleton draw â€” MoveNet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MoveNet 17 keypoints: 0=nose,5=lShoulder,6=rShoulder,7=lElbow,8=rElbow
// 9=lWrist,10=rWrist,11=lHip,12=rHip,13=lKnee,14=rKnee,15=lAnkle,16=rAnkle
const MN_BONES=[[11,13],[13,15],[12,14],[14,16],[11,12]]
function drawMoveNet(keypoints){
  const W=cv.width,H=cv.height
  const ctx=cv.getContext("2d")
  ctx.strokeStyle="rgba(255,215,0,0.8)"; ctx.lineWidth=3
  for(const[a,b]of MN_BONES){
    const kA=keypoints[a],kB=keypoints[b]
    if(!kA||!kB||kA.score<0.3||kB.score<0.3) continue
    ctx.beginPath();ctx.moveTo(kA.x*W,kA.y*H);ctx.lineTo(kB.x*W,kB.y*H);ctx.stroke()
  }
  for(const i of[11,12,13,14,15,16]){
    const k=keypoints[i]; if(!k||k.score<0.3) continue
    ctx.beginPath();ctx.arc(k.x*W,k.y*H,7,0,Math.PI*2)
    ctx.fillStyle=i===15?"#00FF96":i<=12?"#FF6B6B":"#FFD700"; ctx.fill()
  }
}

// â”€â”€ Main frame loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function frame(){
  if(!vid) return
  if(vid.paused||vid.ended){if(vid.ended)onEnded();return}
  if(vid.currentTime===lastT){raf=requestAnimationFrame(frame);return}
  lastT=vid.currentTime

  if(!vid.videoWidth){raf=requestAnimationFrame(frame);return}
  cv.width=vid.videoWidth; cv.height=vid.videoHeight
  const ctx=cv.getContext("2d"); ctx.clearRect(0,0,cv.width,cv.height)

  try{
    let ankleY=null
    if(activeModel==="mediapipe"&&mpLandmarker){
      const r=mpLandmarker.detectForVideo(vid,performance.now())
      const lms=r&&r.landmarks&&r.landmarks[0]
      if(lms){ drawMediaPipe(lms); ankleY=getAnkleY_MediaPipe(lms) }
    } else if(activeModel==="movenet"&&mnModel){
      // MoveNet expects 192x192 input
      const tensor=window.tf.tidy(()=>{
        return window.tf.image.resizeBilinear(
          window.tf.browser.fromPixels(vid),[192,192]
        ).expandDims(0).cast("int32")
      })
      const result=await mnModel.predict(tensor)
      tensor.dispose()
      const data=await result.data()
      result.dispose()
      // MoveNet output: [1,1,17,3] â†’ [y,x,score] per keypoint
      const keypoints=[]
      for(let i=0;i<17;i++){
        keypoints.push({y:data[i*3],x:data[i*3+1],score:data[i*3+2]})
      }
      drawMoveNet(keypoints)
      ankleY=getAnkleY_MoveNet(keypoints)
    }

    if(ankleY!==null){
      if(smoothed===null) smoothed=ankleY
      smoothed=smoothed*(1-SMOOTH)+ankleY*SMOOTH
      signal.push({t:vid.currentTime, y:smoothed})
    }
  }catch(e){}
  raf=requestAnimationFrame(frame)
}

// â”€â”€ Spike detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectSpikes(signal){
  if(signal.length<10) return []
  const vals=signal.map(s=>s.y)
  const w=[]
  for(let i=0;i<vals.length;i++){
    let sum=0,cnt=0
    for(let j=Math.max(0,i-SMOOTH_WIN);j<=Math.min(vals.length-1,i+SMOOTH_WIN);j++){sum+=vals[j];cnt++}
    w.push(sum/cnt)
  }
  const minima=[]
  for(let i=1;i<w.length-1;i++){
    if(w[i]<w[i-1]&&w[i]<w[i+1]) minima.push({i,y:w[i]})
  }
  const spikes=[]
  let i=0
  while(i<minima.length){
    const group=[minima[i]]
    let j=i+1
    while(j<minima.length&&minima[j].i-minima[i].i<MIN_GAP){group.push(minima[j]);j++}
    spikes.push(group.reduce((a,b)=>a.y<b.y?a:b))
    i=j
  }
  return spikes
}

// â”€â”€ Draw graph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGraph(spikes){
  const W=graphCanvas.offsetWidth||300
  graphCanvas.width=W; graphCanvas.height=200
  const H=200, pad={t:20,b:28,l:38,r:10}
  const iW=W-pad.l-pad.r, iH=H-pad.t-pad.b
  const ctx=graphCanvas.getContext("2d")
  ctx.fillStyle="#0C0C14"; ctx.fillRect(0,0,W,H)
  const vals=signal.map(s=>s.y)
  const times=signal.map(s=>s.t)
  const minV=Math.min(...vals)-0.005, maxV=Math.max(...vals)+0.005
  const px=i=>pad.l+(i/(vals.length-1))*iW
  const py=v=>pad.t+((v-minV)/(maxV-minV))*iH
  ctx.strokeStyle="#1A1A28"; ctx.lineWidth=1
  for(let g=0;g<=4;g++){
    const y=pad.t+(g/4)*iH
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+iW,y);ctx.stroke()
    ctx.fillStyle="#333";ctx.font="9px Courier New";ctx.textAlign="right"
    ctx.fillText((maxV-((g/4)*(maxV-minV))).toFixed(3),pad.l-3,y+3)
  }
  ctx.strokeStyle="#00FF96"; ctx.lineWidth=2
  ctx.beginPath()
  vals.forEach((v,i)=>i===0?ctx.moveTo(px(i),py(v)):ctx.lineTo(px(i),py(v)))
  ctx.stroke()
  for(const sp of spikes){
    const x=px(sp.i),y=py(sp.y)
    ctx.strokeStyle="rgba(255,107,107,0.4)"; ctx.lineWidth=1
    ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,pad.t+iH);ctx.stroke()
    ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2)
    ctx.fillStyle="#FF6B6B"; ctx.fill()
  }
  const totalT=times[times.length-1]||1
  ctx.fillStyle="#333";ctx.font="9px Courier New";ctx.textAlign="center"
  for(let t=0;t<=4;t++) ctx.fillText(((t/4)*totalT).toFixed(0)+"s",pad.l+(t/4)*iW,H-6)
  graphInfo.textContent=vals.length+" frames Â· "+totalT.toFixed(1)+"s Â· "+spikes.length+" spikes"
}

// â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onEnded(){
  cancelAnimationFrame(raf)
  pill.textContent="ğŸ” Counting..."
  stateVal.textContent="COUNTING"; stateVal.style.color="#FFD700"
  stateHint.textContent="Analysing signal..."
  setTimeout(()=>{
    const spikes=detectSpikes(signal)
    const count=spikes.length
    repNum.textContent=count
    pill.textContent="âœ… Done"
    stateVal.textContent="DONE"; stateVal.style.color="#00FF96"
    stateHint.textContent=count+" step-ups detected"
    doneBanner.textContent="âœ… "+count+" step-up"+(count!==1?"s":"")+" detected"
    doneBanner.style.display="block"
    resetBtn.style.display="block"
    graphBox.style.display="block"
    setTimeout(()=>drawGraph(spikes),100)
  },200)
}

function resetState(){
  cancelAnimationFrame(raf)
  lastT=-1; smoothed=null; signal=[]
  repNum.textContent="0"
  stateVal.textContent="--"; stateVal.style.color="#555"
  stateHint.textContent="Waiting for video..."
  doneBanner.style.display="none"
  graphBox.style.display="none"
  resetBtn.style.display="none"
  statusMsg.textContent=""
}

window.resetAll=function(){
  resetState()
  vid.currentTime=0; vid.pause()
  pill.textContent="âœ… Ready"
}

document.getElementById("fileIn").addEventListener("change",function(e){
  const f=e.target.files&&e.target.files[0]; if(!f) return
  resetState()
  empty.style.display="none"
  vid.style.display="block"; cv.style.display="block"
  vid.src=URL.createObjectURL(f); vid.load()
  pill.textContent="âœ… Ready"
  statusMsg.textContent="Video loaded â€” press play!"
  setTimeout(()=>{statusMsg.textContent=""},3000)
})

vid.addEventListener("play",()=>{
  pill.textContent="â–¶ Recording..."
  stateVal.textContent="RECORDING"; stateVal.style.color="#FFD700"
  stateHint.textContent="Recording ankle signal..."
  statusMsg.textContent=""; lastT=-1
  raf=requestAnimationFrame(frame)
})
vid.addEventListener("pause",()=>{ cancelAnimationFrame(raf); pill.textContent="âœ… Ready" })

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadModel()
</script>

</body>
</html>