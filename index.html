<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Step-Up Counter</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="StepUp"/>
<meta name="theme-color" content="#08080F"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:#08080F;overscroll-behavior:none;font-family:'Courier New',Courier,monospace;color:#E0E0F0}
body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
button{font-family:inherit;cursor:pointer}
#app{padding:12px 16px;padding-top:max(12px,env(safe-area-inset-top));padding-bottom:max(24px,env(safe-area-inset-bottom));min-height:100vh}
.glow{position:fixed;top:-20%;left:-10%;width:65vw;height:65vw;border-radius:50%;background:radial-gradient(circle,rgba(0,255,150,0.07) 0%,transparent 70%);pointer-events:none}
.tip{display:flex;align-items:flex-start;justify-content:space-between;background:rgba(0,255,150,0.07);border:1px solid rgba(0,255,150,0.2);border-radius:10px;padding:10px 12px;margin-bottom:14px}
.tip span{font-size:12px;color:#888;line-height:18px;flex:1}
.tip button{background:none;border:none;color:#555;font-size:16px;padding-left:10px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.app-title{font-size:16px;font-weight:bold;letter-spacing:3px;color:#00FF96}
.app-sub{font-size:10px;letter-spacing:1.5px;color:#555;margin-top:2px}
.pill{font-size:11px;background:rgba(0,255,150,0.08);border:1px solid rgba(0,255,150,0.2);border-radius:20px;padding:5px 11px;color:#00FF96}
.pill.err{color:#FF6B6B;background:rgba(255,107,107,0.08);border-color:rgba(255,107,107,0.2)}
.videobox{background:#10101A;border-radius:12px;border:1px solid #1E1E30;overflow:hidden;min-height:200px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;position:relative}
#vid{width:100%;display:block;min-height:200px;background:#000}
#cv{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.empty{text-align:center;padding:40px 20px;width:100%}
.empty-icon{font-size:52px}
.empty-txt{color:#555;font-size:14px;margin-top:10px}
.empty-hint{color:#333;font-size:11px;margin-top:6px}
.choose-btn{width:100%;padding:14px 0;background:linear-gradient(135deg,#00FF96,#00C97A);color:#08080F;border:none;border-radius:10px;font-size:14px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.choose-btn:disabled{background:#111;color:#444;opacity:0.5;cursor:not-allowed}
.status-msg{text-align:center;font-size:12px;color:#FFD700;margin-bottom:8px;min-height:20px}
.done-banner{background:rgba(0,255,150,0.08);border:1px solid rgba(0,255,150,0.2);border-radius:10px;padding:12px 16px;margin-bottom:12px;color:#00FF96;font-size:13px;text-align:center;display:none}
.stats{display:flex;gap:10px;margin-bottom:12px}
.rep-card{background:linear-gradient(135deg,rgba(0,255,150,0.09),rgba(0,255,150,0.02));border:1px solid rgba(0,255,150,0.2);border-radius:12px;padding:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:110px}
.rep-label{font-size:10px;letter-spacing:3px;color:#00FF96;margin-bottom:6px;opacity:0.8}
.rep-num{font-size:64px;font-weight:bold;color:#00FF96;line-height:1;text-shadow:0 0 30px rgba(0,255,150,0.4)}
.rep-sub{font-size:11px;color:#444;letter-spacing:2px;margin-top:4px}
.state-card{flex:1;background:#10101A;border:1px solid #1E1E30;border-radius:12px;padding:14px}
.card-label{font-size:10px;letter-spacing:2.5px;color:#555;margin-bottom:6px}
.state-badge{font-size:22px;font-weight:bold;margin-bottom:4px}
.card-hint{font-size:10px;color:#333;line-height:15px}
.graph-box{background:#10101A;border:1px solid #1E1E30;border-radius:12px;padding:14px;margin-bottom:12px;display:none}
.graph-title{font-size:10px;letter-spacing:3px;color:#555;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.graph-title span{color:#00FF96;font-size:11px}
#graphCanvas{width:100%;border-radius:6px;display:block}
.graph-legend{display:flex;gap:16px;margin-top:8px;flex-wrap:wrap}
.leg-item{display:flex;align-items:center;gap:5px;font-size:10px;color:#555}
.leg-dot{width:8px;height:8px;border-radius:50%}
.reset-btn{width:100%;padding:12px 0;background:transparent;border:1px solid #2A2A3A;border-radius:10px;color:#555;font-size:12px;letter-spacing:2px;margin-bottom:8px;display:none}
.spacer{height:32px}
</style>
</head>
<body>
<div id="app">
  <div class="glow"></div>
  <div class="tip" id="tip">
    <span>üì≤ Safari: tap Share then "Add to Home Screen" to install as app</span>
    <button onclick="document.getElementById('tip').remove()">‚úï</button>
  </div>
  <div class="header">
    <div style="display:flex;align-items:center;gap:10px">
      <span style="font-size:28px">‚¨Ü</span>
      <div>
        <div class="app-title">STEP-UP COUNTER</div>
        <div class="app-sub">AI Rep Tracker ¬∑ MediaPipe Pose</div>
      </div>
    </div>
    <div class="pill" id="pill">‚è≥ Loading...</div>
  </div>

  <div class="videobox">
    <div class="empty" id="empty">
      <div class="empty-icon">üé¨</div>
      <div class="empty-txt">Upload a step-up workout video</div>
      <div class="empty-hint">MP4 ¬∑ MOV ¬∑ WebM</div>
    </div>
    <video id="vid" playsinline webkit-playsinline controls preload="auto" style="display:none"></video>
    <canvas id="cv" style="display:none"></canvas>
  </div>

<button class="choose-btn" id="chooseBtn" disabled onclick="document.getElementById('fileIn').click()">üìÇ  Choose Video</button>
<input type="file" accept="video/*" id="fileIn" style="display:none"/>

  <div class="status-msg" id="statusMsg">Initialising...</div>
  <div class="done-banner" id="doneBanner"></div>

  <div class="stats">
    <div class="rep-card">
      <div class="rep-label">STEP-UPS</div>
      <div class="rep-num" id="repNum">0</div>
      <div class="rep-sub">reps</div>
    </div>
    <div class="state-card">
      <div class="card-label">STATE</div>
      <div class="state-badge" id="stateVal" style="color:#555">LOW</div>
      <div class="card-hint" id="stateHint">Waiting for video...</div>
    </div>
  </div>

  <!-- Graph shown after video ends -->

  <div class="graph-box" id="graphBox">
    <div class="graph-title">
      LEFT ANKLE Y ‚Äî FULL VIDEO
      <span id="graphFrames">0 frames</span>
    </div>
    <canvas id="graphCanvas" height="180"></canvas>
    <div class="graph-legend">
      <div class="leg-item"><div class="leg-dot" style="background:#00FF96"></div>Left ankle Y (smoothed)</div>
      <div class="leg-item"><div class="leg-dot" style="background:#FFD700"></div>Baseline</div>
      <div class="leg-item"><div class="leg-dot" style="background:#FF6B6B"></div>HIGH threshold</div>
      <div class="leg-item"><div class="leg-dot" style="background:#444;border:1px solid #666"></div>Count event</div>
    </div>
  </div>

<button class="reset-btn" id="resetBtn" onclick="resetAll()">‚Ü∫  Reset Counter</button>

  <div class="spacer"></div>
</div>

<script type="module">
const CDN = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14"
const MODEL = "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"

const HIGH_THRESH = -0.06
const LOW_THRESH  = -0.02
const SMOOTH      = 0.2

const vid=document.getElementById("vid")
const cv=document.getElementById("cv")
const pill=document.getElementById("pill")
const statusMsg=document.getElementById("statusMsg")
const repNum=document.getElementById("repNum")
const stateVal=document.getElementById("stateVal")
const stateHint=document.getElementById("stateHint")
const doneBanner=document.getElementById("doneBanner")
const chooseBtn=document.getElementById("chooseBtn")
const resetBtn=document.getElementById("resetBtn")
const empty=document.getElementById("empty")
const graphBox=document.getElementById("graphBox")
const graphCanvas=document.getElementById("graphCanvas")
const graphFrames=document.getElementById("graphFrames")

let lmk=null, raf=null, lastT=-1, count=0
let state="LOW", smoothedAnkle=null, baseline=null

// Recording arrays
let recordedAnkle=[]    // raw avg ankle Y per frame
let recordedSmooth=[]   // smoothed ankle Y
let recordedBaseline=[] // baseline per frame
let recordedTime=[]     // video timestamp
let countEvents=[]      // timestamps where a rep was counted

const BONES=[[23,25],[25,27],[24,26],[26,28],[23,24]]
const KP=[23,24,25,26,27,28]

function draw(sets){
  if(!vid.videoWidth)return
  cv.width=vid.videoWidth;cv.height=vid.videoHeight
  const ctx=cv.getContext("2d");ctx.clearRect(0,0,cv.width,cv.height)
  if(!sets||!sets.length)return
  const lms=sets[0],W=cv.width,H=cv.height
  const boneCol=state==="HIGH"?"rgba(0,255,150,0.9)":"rgba(255,215,0,0.7)"
  ctx.lineWidth=3
  for(const[a,b]of BONES){
    if(!lms[a]||!lms[b])continue
    ctx.strokeStyle=boneCol
    ctx.beginPath();ctx.moveTo(lms[a].x*W,lms[a].y*H);ctx.lineTo(lms[b].x*W,lms[b].y*H);ctx.stroke()
  }
  for(const i of KP){
    if(!lms[i])continue
    ctx.beginPath();ctx.arc(lms[i].x*W,lms[i].y*H,7,0,Math.PI*2)
    ctx.fillStyle=(i===27||i===28)?(state==="HIGH"?"#00FF96":"#FFD700"):"#FF6B6B"
    ctx.fill()
  }
}

function setUIState(s){
  state=s
  stateVal.textContent=s==="HIGH"?"HIGH":"LOW"
  stateVal.style.color=s==="HIGH"?"#00FF96":"#FFD700"
  stateHint.textContent=s==="HIGH"?"On step ‚Äî come back down for +1":"On ground ‚Äî step up to count"
}

function drawGraph(){
  const data=recordedSmooth
  const base=recordedBaseline
  const times=recordedTime
  if(!data.length)return

  const W=graphCanvas.offsetWidth||300
  graphCanvas.width=W
  graphCanvas.height=180
  const H=180
  const pad={t:16,b:24,l:36,r:10}
  const iW=W-pad.l-pad.r
  const iH=H-pad.t-pad.b

  const ctx=graphCanvas.getContext("2d")
  ctx.clearRect(0,0,W,H)

  // Background
  ctx.fillStyle="#0C0C14"
  ctx.fillRect(0,0,W,H)

  // Find Y range
  const allVals=[...data,...base]
  let minY=Math.min(...allVals)-0.02
  let maxY=Math.max(...allVals)+0.02

  function px(i){ return pad.l + (i/(data.length-1))*iW }
  function py(v){ return pad.t + ((v-minY)/(maxY-minY))*iH }

  // Grid lines
  ctx.strokeStyle="#1A1A28";ctx.lineWidth=1
  for(let g=0;g<5;g++){
    const y=pad.t+(g/4)*iH
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+iW,y);ctx.stroke()
    const val=maxY-((g/4)*(maxY-minY))
    ctx.fillStyle="#333";ctx.font="9px Courier New";ctx.textAlign="right"
    ctx.fillText(val.toFixed(2),pad.l-3,y+3)
  }

  // HIGH threshold line
  const highY=py(( baseline[0]||0 )+HIGH_THRESH)
  ctx.strokeStyle="rgba(255,107,107,0.5)";ctx.lineWidth=1;ctx.setLineDash([4,4])
  ctx.beginPath();ctx.moveTo(pad.l,highY);ctx.lineTo(pad.l+iW,highY);ctx.stroke()
  ctx.setLineDash([])
  ctx.fillStyle="#FF6B6B";ctx.font="9px Courier New";ctx.textAlign="left"
  ctx.fillText("HIGH",pad.l+2,highY-3)

  // Count event vertical lines
  for(const t of countEvents){
    const idx=times.findIndex(x=>x>=t)
    if(idx<0)continue
    const x=px(idx)
    ctx.strokeStyle="rgba(255,255,255,0.2)";ctx.lineWidth=1
    ctx.beginPath();ctx.moveTo(x,pad.t);ctx.lineTo(x,pad.t+iH);ctx.stroke()
    ctx.fillStyle="#888";ctx.font="9px Courier New";ctx.textAlign="center"
    ctx.fillText("+1",x,pad.t+8)
  }

  // Baseline line
  ctx.strokeStyle="rgba(255,215,0,0.5)";ctx.lineWidth=1.5
  ctx.beginPath()
  base.forEach((v,i)=>{ i===0?ctx.moveTo(px(i),py(v)):ctx.lineTo(px(i),py(v)) })
  ctx.stroke()

  // Ankle signal line
  ctx.strokeStyle="#00FF96";ctx.lineWidth=2
  ctx.beginPath()
  data.forEach((v,i)=>{ i===0?ctx.moveTo(px(i),py(v)):ctx.lineTo(px(i),py(v)) })
  ctx.stroke()

  // X axis labels (time)
  const totalT=times[times.length-1]||1
  ctx.fillStyle="#333";ctx.font="9px Courier New";ctx.textAlign="center"
  for(let t=0;t<=4;t++){
    const x=pad.l+(t/4)*iW
    const sec=((t/4)*totalT).toFixed(1)
    ctx.fillText(sec+"s",x,H-4)
  }

  graphFrames.textContent=data.length+" frames ¬∑ "+totalT.toFixed(1)+"s"
}

function frame(){
  if(!vid||!lmk)return
  if(vid.paused||vid.ended){if(vid.ended)onEnded();return}
  if(vid.currentTime===lastT){raf=requestAnimationFrame(frame);return}
  lastT=vid.currentTime
  try{
    const r=lmk.detectForVideo(vid,performance.now())
    const lms=r&&r.landmarks&&r.landmarks[0]
    if(!lms){raf=requestAnimationFrame(frame);return}

    const avgAnkle=lms[27].y
    if(smoothedAnkle===null)smoothedAnkle=avgAnkle
    smoothedAnkle=smoothedAnkle*(1-SMOOTH)+avgAnkle*SMOOTH
    if(baseline===null)baseline=smoothedAnkle
    if(state==="LOW")baseline=baseline*0.98+smoothedAnkle*0.02

    const delta=smoothedAnkle-baseline

    // Record every frame
    recordedAnkle.push(avgAnkle)
    recordedSmooth.push(smoothedAnkle)
    recordedBaseline.push(baseline)
    recordedTime.push(vid.currentTime)

    draw(r.landmarks)

    // Count logic
    if(state==="LOW"&&delta<HIGH_THRESH){
      setUIState("HIGH")
    } else if(state==="HIGH"&&delta>LOW_THRESH){
      count++
      repNum.textContent=count
      resetBtn.style.display="block"
      countEvents.push(vid.currentTime)
      setUIState("LOW")
    }
  }catch(e){}
  raf=requestAnimationFrame(frame)
}

function onEnded(){
  cancelAnimationFrame(raf)
  pill.textContent="‚úÖ Done"
  doneBanner.textContent="‚úÖ Done ‚Äî "+count+" step-up"+(count!==1?"s":"")+" detected"
  doneBanner.style.display="block"
  resetBtn.style.display="block"
  // Show graph
  graphBox.style.display="block"
  setTimeout(drawGraph, 100)
}

window.resetAll=function(){
  cancelAnimationFrame(raf)
  count=0;lastT=-1;state="LOW";smoothedAnkle=null;baseline=null
  recordedAnkle=[];recordedSmooth=[];recordedBaseline=[];recordedTime=[];countEvents=[]
  repNum.textContent="0"
  setUIState("LOW")
  stateHint.textContent="Waiting for video..."
  doneBanner.style.display="none"
  graphBox.style.display="none"
  resetBtn.style.display="none"
  vid.currentTime=0;vid.pause()
  pill.textContent="‚úÖ Ready"
}

document.getElementById("fileIn").addEventListener("change",function(e){
  const f=e.target.files&&e.target.files[0];if(!f)return
  cancelAnimationFrame(raf)
  count=0;lastT=-1;state="LOW";smoothedAnkle=null;baseline=null
  recordedAnkle=[];recordedSmooth=[];recordedBaseline=[];recordedTime=[];countEvents=[]
  repNum.textContent="0"
  setUIState("LOW")
  stateHint.textContent="Waiting for video..."
  doneBanner.style.display="none"
  graphBox.style.display="none"
  resetBtn.style.display="none"
  empty.style.display="none"
  vid.style.display="block"
  cv.style.display="block"
  vid.src=URL.createObjectURL(f)
  vid.load()
  pill.textContent="‚úÖ Ready"
  statusMsg.textContent="Video loaded ‚Äî press play!"
  setTimeout(()=>{statusMsg.textContent=""},3000)
})

vid.addEventListener("play",function(){
  pill.textContent="‚ñ∂ Analysing"
  statusMsg.textContent=""
  lastT=-1
  raf=requestAnimationFrame(frame)
})
vid.addEventListener("pause",function(){
  cancelAnimationFrame(raf)
  pill.textContent="‚úÖ Ready"
  // Draw graph with whatever we have so far
  if(recordedSmooth.length>10){
    graphBox.style.display="block"
    setTimeout(drawGraph,100)
  }
})

;(async()=>{
  try{
    statusMsg.textContent="Loading MediaPipe..."
    const{PoseLandmarker,FilesetResolver}=await import(CDN+"/vision_bundle.mjs")
    statusMsg.textContent="Downloading model (~10MB)..."
    const res=await FilesetResolver.forVisionTasks(CDN+"/wasm")
    lmk=await PoseLandmarker.createFromOptions(res,{
      baseOptions:{modelAssetPath:MODEL,delegate:"CPU"},
      runningMode:"VIDEO",numPoses:1
    })
    pill.textContent="‚úÖ Ready"
    statusMsg.textContent=""
    chooseBtn.disabled=false
  }catch(e){
    pill.textContent="‚ùå Error"
    pill.classList.add("err")
    statusMsg.textContent="Failed: "+e.message
  }
})()
</script>

</body>
</html>